#!/usr/bin/env bash

function usage {
  echo "Usage: $(basename $0) [-h] [-m SSH_MACHINE] [-c CONFIG_NAME] [-n NUM_OF_PROC] [-a IC_ACCESS] [-w WALLTIME] [-s SCRIPT] [MACHINE [NUM_OF_PROC] ...]" 2>&1
  echo "Starts experiments to run on Inria machines."
  echo "  Takes a list of machines [MACHINE [NUM_OF_PROC]] as argument that defines where the experiments should run."
  echo "  MACHINE is the name of the machine as defined in the configuration of the exputils project file."
  echo "  The optimal argument NUM_OF_PROC is the number of parallel processes that should run on the machine."
  echo "  Options:"
  echo "   -h             Shows this message."
  echo "   -m SSH_MACHINE Name of the machine to which it will connect via ssh and execute the eu_inria_run_experiments command. (Default=$EU_PRJ_INRIA_DEFAULT_MACHINE)"
  echo "   -c CONFIG_NAME Name of the default config that should be used. Configurations are defined in the exputils project file. (Default=$EU_PRJ_INRIA_TARGET_MACHINE_DEFAULT_CONFIG)"
  echo "   -n NUM_OF_PROC Number of parallel processes."
  echo "   -a IC_ACCESS   Name of the access machine for the cluster where oarjobs can be submitted. (Default=$EU_PRJ_INRIA_CLUSTER_ACCESS_MACHINE)"
  echo "   -s SCRIPT      Scripts that should be executed. (Default=$EU_PRJ_DEFAULT_RUN_REPETITION_SCRIPT)"
  echo "   -w WALLTIME    Walltime for cluster jobs. Format: HH:MM:SS. (Default=$EU_PRJ_INRIA_CLUSTER_DEFAULT_WALLTIME)"
}

##################################
# parameters
ssh_machine=$EU_PRJ_INRIA_DEFAULT_MACHINE

# handle arguments
arguments=
while getopts ":hm:a:c:w:n:s:" arg; do
  case $arg in
    h) usage ; exit 1 ;;
    m) ssh_machine=$OPTARG;;
    a) arguments="$arguments -a $OPTARG";;
    c) arguments="$arguments -c $OPTARG";;
    w) arguments="$arguments -w $OPTARG";;
    n) arguments="$arguments -n $OPTARG";;
    s) arguments="$arguments -s $OPTARG";;
    ?) echo "Invalid option: -${OPTARG}."; usage ; exit 2 ;;
  esac
done
# get all arguments are given after the options handled by getopts
shift $(expr $OPTIND - 1 )
arguments="$arguments $@"


# path to experiments on the local host
LOCAL_EXPERIMENTS_DIR=$EU_PRJ_LOCAL_EXPERIMENTS_PATH
# path to the experiments directory on the target host
EXTERNAL_EXPERIMENTS_DIR=$EU_PRJ_INRIA_EXPERIMENTS_PATH
# replace the path to the experiments on local host with the one at the target host
LOCAL_SCRIPT_PATH=`pwd`
EXTERNAL_SCRIPT_PATH=`echo $LOCAL_SCRIPT_PATH | sed "s+${LOCAL_EXPERIMENTS_DIR}+${EXTERNAL_EXPERIMENTS_DIR}+g"`

# got to the current experiment directory on the target host and start the "run_experiments.sh" script
ssh $ssh_machine "source eu_activate $EU_ACTIVE_PRJ; cd ${EXTERNAL_SCRIPT_PATH};  eu_inria_run_experiments $arguments"
